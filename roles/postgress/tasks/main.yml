# ==================================================
# FILE: roles/postgress/tasks/main.yml
#
# For badatabase install
# ==================================================
---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

## Install dependences and postgres  
- name: "Install packages"
  apt: "name={{ item }} state=present"
  with_items:
    - postgresql-client
    - postgresql-contrib
    - postgresql
    - python3-psycopg2
    # - pipx
  # notify: Restart postgress
    

- name: Check if database 'peer' exists before install or update 
  become: yes
  become_user: peer  # Connect as postgres superuser
  ansible.builtin.shell:
    cmd: psql -lqt | grep -qw '{{ database_name }}' | grep 'does not exist'
  register: db_exists
  ignore_errors: yes

- name: what is there in db_exists
  debug: 
    msg: "db_exists {{ db_exists }}"

- name: Display database creation status
  debug:
    msg: "{{ 'Database created' if db_exists.changed else 'Database already exists' }}"

- meta: end_play

- name: BLOCK create peer database
  when: db_exists is not defined
  block:
    - name: Read password from file if it exists
      slurp:
        path: "{{ path_to_file_on_host }}"
      register: password_file_content
      when: path_to_file_on_host is defined
      ignore_errors: yes

    - name: Set password from file or use default
      set_fact:
        actual_password: "{{ password_file_content['content'] | b64decode | trim if password_file_content is success else database_password }}"

    - name: Create PostgreSQL user
      become: yes
      become_user: peer
      postgresql_user:
        name: "{{ database_user }}"
        password: "{{ actual_password }}"
        state: present
        login_unix_socket: /var/run/postgresql
      no_log: true  # Don't log password

    - name: Grant table permissions to user
      become: yes
      become_user: peer
      postgresql_privs:
        database: "{{ database_name }}"
        state: present
        privs: SELECT,INSERT,UPDATE,DELETE
        type: table
        objs: ALL_IN_SCHEMA
        schema: public
        role: "{{ database_user }}"
        login_unix_socket: /var/run/postgresql

    - name: Grant default table privileges for new tables
      become: yes
      become_user: peer
      postgresql_query:
        db: "{{ database_name }}"
        query: "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO {{ database_user }};"
        login_unix_socket: /var/run/postgresql

    - name: Grant sequence permissions to user
      become: yes
      become_user: peer
      postgresql_privs:
        database: "{{ database_name }}"
        state: present
        privs: USAGE,SELECT
        type: sequence
        objs: ALL_IN_SCHEMA
        schema: public
        role: "{{ database_user }}"
        login_unix_socket: /var/run/postgresql

    - name: Grant default sequence privileges for new sequences
      become: yes
      become_user: peer
      postgresql_query:
        db: "{{ database_name }}"
        query: "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO {{ database_user }};"
        login_unix_socket: /var/run/postgresql

    - name: Ensure PostgreSQL is listening on correct interface
      lineinfile:
        path: /etc/postgresql/*/main/postgresql.conf
        regexp: '^#?listen_addresses'
        line: "listen_addresses = '{{ Internal_Database }}'"
        backup: yes
      notify: Restart PostgreSQL

    - name: Configure pg_hba.conf for network access
      blockinfile:
        path: /etc/postgresql/*/main/pg_hba.conf
        marker: "# {mark} ANSIBLE MANAGED - Backend Access"
        block: |
          # Allow backend server to connect
          host    {{ database_name }}    {{ database_user }}    {{ Internal_Backend }}/32    md5
          # Allow connections from same network
          host    {{ database_name }}    {{ database_user }}    192.168.1.0/24         md5
        backup: yes
      notify: Restart PostgreSQL


### Import data for database
##   
- name: BLOCK import data to database
  when: db_exists is defined
  block:
    - name: Check if structure SQL file exists on remote host
      stat:
        path: "{{ sql_structure_file }}"
      register: structure_file
      when: sql_structure_file is defined

    - name: Import structure into PostgreSQL
      become: yes
      become_user: peer
      shell: |
        psql -d {{ database_name }} -f {{ sql_structure_file }}
      when:
        - sql_structure_file is defined
        - structure_file.stat.exists
      register: structure_import

    - name: Display structure import result
      debug:
        msg: "Structure imported from {{ sql_structure_file }}"
      when:
        - structure_import is defined
        - structure_import.changed

    - name: Check if optional data SQL file exists on remote host
      stat:
        path: "{{ sql_optional_data_file }}"
      register: optional_file
      when: sql_optional_data_file is defined

    - name: Import optional data into PostgreSQL
      become: yes
      become_user: peer
      shell: |
        psql -d {{ database_name }} -f {{ sql_optional_data_file }}
      when:
        - sql_optional_data_file is defined
        - optional_file.stat.exists
      register: optional_import

    - name: Display optional data import result
      debug:
        msg: "Optional data imported from {{ sql_optional_data_file }}"
      when:
        - optional_import is defined
        - optional_import.changed


- name: Check if database 'peer' exists
  become: yes
  become_user: peer
  postgresql_db:
    name: "{{ database_name }}"
    state: present
  register: db_exists


- name: Display database creation status
  debug:
    msg: "{{ 'Database peer created' if db_exists.changed else 'Database peer already exists' }}"

- name: Check if SQL structure file exists
  stat:
    path: "{{ sql_structure_file }}"
  register: structure_file
  when: sql_structure_file is defined

- name: Import structure into PostgreSQL database
  become: yes
  become_user: peer
  postgresql_query:
    db: peer
    path_to_script: "{{ sql_structure_file }}"
  when: 
    - sql_structure_file is defined
    - structure_file.stat.exists
  register: structure_import

- name: Display structure import status
  debug:
    msg: "Structure imported from {{ sql_structure_file }}"
  when: 
    - structure_import is defined
    - structure_import.changed

- name: Check if optional data file exists
  stat:
    path: "{{ sql_optional_data_file }}"
  register: optional_file
  when: sql_optional_data_file is defined

- name: Import optional data into PostgreSQL database
  become: yes
  become_user: peer
  postgresql_query:
    db: peer
    path_to_script: "{{ sql_optional_data_file }}"
  when:
    - sql_optional_data_file is defined
    - optional_file.stat.exists
  register: optional_import

- name: Display optional data import status
  debug:
    msg: "Optional data imported from {{ sql_optional_data_file }}"
  when:
    - optional_import is defined
    - optional_import.changed

- name: Create PostgreSQL user 'peer_beta'
  become: yes
  become_user: peer
  postgresql_user:
    name: peer_beta
    password: "{{ postgres_peer_beta_password }}"
    state: present
    encrypted: yes

- name: Grant table permissions to peer_beta on existing tables
  become: yes
  become_user: peer
  postgresql_privs:
    database: peer
    state: present
    privs: SELECT,INSERT,UPDATE,DELETE
    type: table
    objs: ALL_IN_SCHEMA
    schema: public
    role: peer_beta

- name: Grant default table permissions for new tables
  become: yes
  become_user: peer
  postgresql_query:
    db: peer
    query: "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO peer_beta;"

- name: Grant sequence permissions to peer_beta on existing sequences
  become: yes
  become_user: peer
  postgresql_privs:
    database: peer
    state: present
    privs: USAGE,SELECT
    type: sequence
    objs: ALL_IN_SCHEMA
    schema: public
    role: peer_beta

- name: Grant default sequence permissions for new sequences
  become: yes
  become_user: peer
  postgresql_query:
    db: peer
    query: "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO peer_beta;"

- name: Display completion message
  debug:
    msg:
      - "âœ“ PostgreSQL setup complete"
      - "  - Database 'peer' created"
      - "  - User 'peer_beta' created with permissions"
      - "  - Grants configured for tables and sequences"
      - ""
      - "Connection details:"
      - "  Host: {{ Internal_IP_target }}"
      - "  Port: {{ psql_port }}"
      - "  Database: peer"
      - "  User: peer_beta"