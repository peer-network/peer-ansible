# ==================================================
# FILE: roles/postgress/tasks/main.yml
#
# For daaatabase install
# ==================================================
---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

## Install dependences and postgres  
- name: "Install packages"
  apt: "name={{ item }} state=present"
  with_items:
    - postgresql-client
    - postgresql-contrib
    - postgresql
    - python3-psycopg2
    # - pipx
  # notify: Restart postgress
    
  # postgres password {{ prod_root }}

- name: Check if database '{{ database_name }}' exists
  become: yes
  become_user: postgres
  ansible.builtin.shell:
    cmd: psql -lqt | cut -d '|' -f 1 | grep -qw "{{ database_name }}"
  register: db_exists
  ignore_errors: yes

- name: Show database existence
  debug:
    msg: "Database {{ database_name }} {{'exists' if db_exists.rc == 0 else 'does not exist'}}. {{ db_exists }}"

- name: Bad Database error on check, end play?
  ansible.builtin.meta: end_play
  when: db_exists.rc > 1  # stop for any non [0,1] database check errors 

  ### Database is not defined, need to create it. -------------------
  ##  The database needs to be created 
  ##  Assume psql is running
- name: BLOCK create peer database
  when: db_exists.rc != 0  # An error in database check, 
  block:

    ### Create local database
    - name: Create database
      become_user: postgres
      postgresql_db:
        name: "{{ database_name }}"
        login_unix_socket: /var/run/postgresql  

    - name: Ping PostgreSQL
      become_user: postgres
      postgresql_ping:
        db: "{{ database_name }}"
        login_unix_socket: "/var/run/postgresql"
        login_user: postgres
      register: db_status

    - name: Show database existence
      debug:
        msg: "Database {{ database_name }} Status: {{ db_status }}"


    ### Configure the database
    ###
    ## Find version of postgres to setup paths
    - name: CONFIG Find PostgreSQL version
      shell: ls /etc/postgresql/ | head -1
      register: pg_version
      changed_when: false

    - name: CONFIG CONFIG Set PostgreSQL configuration paths
      set_fact:
        pg_version_num: "{{ pg_version.stdout }}"
        pg_data_dir: "/etc/postgresql/{{ pg_version.stdout }}/main"
        pg_conf: "/etc/postgresql/{{ pg_version.stdout }}/main/postgresql.conf"
        pg_hba: "/etc/postgresql/{{ pg_version.stdout }}/main/pg_hba.conf"
        
    - name: CONFIG Backup postgresql.conf
      copy:
        src: "{{ pg_conf }}"
        dest: "{{ pg_conf }}.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes
        force: no

    - name: CONFIG Configure PostgreSQL to listen on network
      lineinfile:
        path: "{{ pg_conf }}"
        regexp: '^#?listen_addresses'
        line: "listen_addresses = 'localhost,{{ Internal_Database }}'"
        backup: yes
      notify: Restart PostgreSQL

    - name: CONFIG Configure PostgreSQL port
      lineinfile:
        path: "{{ pg_conf }}"
        regexp: '^#?port'
        line: "port = {{ psql_port }}"
        backup: yes
      notify: Restart PostgreSQL

    - name: CONFIG Configure max_connections
      lineinfile:
        path: "{{ pg_conf }}"
        regexp: '^#?max_connections'
        line: "max_connections = 300"
        backup: yes
      notify: Restart PostgreSQL

    - name: CONFIG Backup pg_hba.conf
      copy:
        src: "{{ pg_hba }}"
        dest: "{{ pg_hba }}.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes
        force: no

    - name: CONFIG Configure pg_hba.conf for authentication
      blockinfile:
        path: "{{ pg_hba }}"
        marker: "# {mark} ANSIBLE MANAGED AUTHENTICATION"
        insertafter: "^# TYPE"
        block: |
          # Local socket connections
          local   all             postgres                                peer
          local   all             all                                     md5
          
          # IPv4 local connections
          host    all             all             127.0.0.1/32            md5
          host    all             all             ::1/128                 md5
          
          # Backend server access
          host    {{ database_name }}    {{ database_user }}       {{ Internal_Backend }}/32    md5
          
          # Local network access (192.168.1.0/24)
          host    {{ database_name }}    {{ database_user }}       192.168.1.0/24               md5
          
          # Master user access from backend
          host    all             postgres                         {{ Internal_Backend }}/32    md5
          host    all             postgres                         192.168.1.0/24               md5
      notify: Reload PostgreSQL

    - name: CONFIG Flush handlers to reload PostgreSQL config
      meta: flush_handlers

    - name: CONFIG Wait for PostgreSQL to be ready
      wait_for:
        port: "{{ psql_port }}"
        delay: 2
        timeout: 30

    - name: CONFIG Set postgres (master) user password
      become_user: postgres
      postgresql_user:
        name: postgres
        password: "{{ prod_root }}"
        role_attr_flags: SUPERUSER,CREATEDB,CREATEROLE,REPLICATION
        login_unix_socket: /var/run/postgresql
      no_log: true  

    - name: Diag end-play
      ansible.builtin.meta: end_play


    ### USER set peer -----
    ## 
    - name: USER Create PostgreSQL user
      become: yes
      become_user: peer
      postgresql_user:
        name: "{{ database_user }}"
        password: "{{ staging_root }}"
        state: present
        login_unix_socket: /var/run/postgresql
      no_log: true  # Don't log password

    - name: GUSER rant table permissions to user
      become: yes
      become_user: peer
      postgresql_privs:
        database: "{{ database_name }}"
        state: present
        privs: SELECT,INSERT,UPDATE,DELETE
        type: table
        objs: ALL_IN_SCHEMA
        schema: public
        role: "{{ database_user }}"
        login_unix_socket: /var/run/postgresql

    - name: USER Grant default table privileges for new tables
      become: yes
      become_user: peer
      postgresql_query:
        db: "{{ database_name }}"
        query: "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO {{ database_user }};"
        login_unix_socket: /var/run/postgresql

    - name: USER Grant sequence permissions to user
      become: yes
      become_user: peer
      postgresql_privs:
        database: "{{ database_name }}"
        state: present
        privs: USAGE,SELECT
        type: sequence
        objs: ALL_IN_SCHEMA
        schema: public
        role: "{{ database_user }}"
        login_unix_socket: /var/run/postgresql

    - name: USER Grant default sequence privileges for new sequences
      become: yes
      become_user: peer
      postgresql_query:
        db: "{{ database_name }}"
        query: "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO {{ database_user }};"
        login_unix_socket: /var/run/postgresql

    - name: Ensure PostgreSQL is listening on correct interface
      lineinfile:
        path: /etc/postgresql/*/main/postgresql.conf
        regexp: '^#?listen_addresses'
        line: "listen_addresses = '{{ Internal_Database }}'"
        backup: yes
      notify: Restart PostgreSQL

    # - name: Configure pg_hba.conf for network access
    #   blockinfile:
    #     path: /etc/postgresql/*/main/pg_hba.conf
    #     marker: "# {mark} ANSIBLE MANAGED - Backend Access"
    #     block: |
    #       # Allow backend server to connect
    #       host    {{ database_name }}    {{ database_user }}    {{ Internal_Backend }}/32    md5
    #       # Allow connections from same network
    #       host    {{ database_name }}    {{ database_user }}    192.168.1.0/24         md5
    #       host    {{ database_name }}    {{ database_user }}    162.19.169.215/32         md5
    #     backup: yes
    #   notify: Restart PostgreSQL
  ## End of block

### Database is there and can recive more data
### Import data for database
##   
- name: BLOCK import data to database
  when: db_exists.rc == 0  # No error in database check
  block:
    - name: Check if structure SQL file exists on remote host
      stat:
        path: "{{ sql_structure_file }}"
      register: structure_file
      when: sql_structure_file is defined

    - name: Import structure into PostgreSQL
      become: yes
      become_user: peer
      shell: |
        psql -d {{ database_name }} -f {{ sql_structure_file }}
      when:
        - sql_structure_file is defined
        - structure_file.stat.exists
      register: structure_import

    - name: Display structure import result
      debug:
        msg: "Structure imported from {{ sql_structure_file }}"
      when:
        - structure_import is defined
        - structure_import.changed

    - name: Check if optional data SQL file exists on remote host
      stat:
        path: "{{ sql_optional_data_file }}"
      register: optional_file
      when: sql_optional_data_file is defined

    - name: Import optional data into PostgreSQL
      become: yes
      become_user: peer
      shell: |
        psql -d {{ database_name }} -f {{ sql_optional_data_file }}
      when:
        - sql_optional_data_file is defined
        - optional_file.stat.exists
      register: optional_import

    - name: Display optional data import result
      debug:
        msg: "Optional data imported from {{ sql_optional_data_file }}"
      when:
        - optional_import is defined
        - optional_import.changed
  ## End of block
  
- name: Display database creation status
  debug:
    msg: "{{ 'Database peer created' if db_exists.changed else 'Database peer already exists' }}"

- name: Check if SQL structure file exists
  stat:
    path: "{{ sql_structure_file }}"
  register: structure_file
  when: sql_structure_file is defined

- name: Import structure into PostgreSQL database
  become: yes
  become_user: peer
  postgresql_query:
    db: peer
    path_to_script: "{{ sql_structure_file }}"
  when: 
    - sql_structure_file is defined
    - structure_file.stat.exists
  register: structure_import

- name: Display structure import status
  debug:
    msg: "Structure imported from {{ sql_structure_file }}"
  when: 
    - structure_import is defined
    - structure_import.changed

- name: Check if optional data file exists
  stat:
    path: "{{ sql_optional_data_file }}"
  register: optional_file
  when: sql_optional_data_file is defined

- name: Import optional data into PostgreSQL database
  become: yes
  become_user: peer
  postgresql_query:
    db: peer
    path_to_script: "{{ sql_optional_data_file }}"
  when:
    - sql_optional_data_file is defined
    - optional_file.stat.exists
  register: optional_import

- name: Display optional data import status
  debug:
    msg: "Optional data imported from {{ sql_optional_data_file }}"
  when:
    - optional_import is defined
    - optional_import.changed

- name: Create PostgreSQL user 'peer_beta'
  become: yes
  become_user: peer
  postgresql_user:
    name: peer_beta
    password: "{{ postgres_peer_beta_password }}"
    state: present
    encrypted: yes

- name: Grant table permissions to peer_beta on existing tables
  become: yes
  become_user: peer
  postgresql_privs:
    database: peer
    state: present
    privs: SELECT,INSERT,UPDATE,DELETE
    type: table
    objs: ALL_IN_SCHEMA
    schema: public
    role: peer_beta

- name: Grant default table permissions for new tables
  become: yes
  become_user: peer
  postgresql_query:
    db: peer
    query: "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO peer_beta;"

- name: Grant sequence permissions to peer_beta on existing sequences
  become: yes
  become_user: peer
  postgresql_privs:
    database: peer
    state: present
    privs: USAGE,SELECT
    type: sequence
    objs: ALL_IN_SCHEMA
    schema: public
    role: peer_beta

- name: Grant default sequence permissions for new sequences
  become: yes
  become_user: peer
  postgresql_query:
    db: peer
    query: "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO peer_beta;"

- name: Display completion message
  debug:
    msg:
      - "âœ“ PostgreSQL setup complete"
      - "  - Database 'peer' created"
      - "  - User 'peer_beta' created with permissions"
      - "  - Grants configured for tables and sequences"
      - ""
      - "Connection details:"
      - "  Host: {{ Internal_IP_target }}"
      - "  Port: {{ psql_port }}"
      - "  Database: peer"
      - "  User: peer_beta"