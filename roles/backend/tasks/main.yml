# ==================================================
# FILE: roles/backend/tasks/main.yml
# Backend server setup (combines PHP, Nginx, Rust)
# ==================================================
---
- name: Display backend setup message
  debug:
    msg: "Setting up backend server with PHP 8.3, Nginx, and Rust"

# The actual installation is handled by role dependencies
# defined in roles/backend/meta/main.yml

- name: Ensure all services are running
  service:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - nginx
    - php8.3-fpm

- name: Verify PHP-FPM socket exists
  stat:
    path: /run/php/php8.3-fpm.sock
  register: php_sock
  failed_when: not php_sock.stat.exists

- name: Display backend server info
  debug:
    msg:
      - "Backend server setup complete!"
      - "PHP Version: 8.3"
      - "Web Server: Nginx"
      - "Document Root: /var/www/html/public"
      - "Test URL: http://{{ ansible_host }}/test.php"

### Set permissions for nginx and php to use
##  for the directories 
- name: Set directory ownership recursively
  file:
    path: /var/www/html
    owner: www-data
    group: www-data
    recurse: yes

- name: Set directory permissions to 755
  file:
    path: "{{ item }}"
    mode: '0755'
    state: directory
  with_fileglob:
    - /var/www/html/**/
  ignore_errors: yes  # in case some nested dirs don't exist yet

### Set permissions for the files 
##
- name: Set file permissions to 644
  find:
    paths: /var/www/html
    file_type: file
  register: found_files  # get all of the files

- name: Apply 644 to all files
  file:
    path: "{{ item.path }}"
    mode: '0644'
  loop: "{{ found_files.files }}"  

  

