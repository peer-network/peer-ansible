# ==================================================
# FILE: roles/nginx/tasks/main.yml
# Installing Nginx:  Setup Nginx configuration
# Matches: cp ./docker/nginx/default.conf ... && systemctl restart
# ==================================================
---
- name: "Installing Nginx:  Ensure Nginx is started and enabled"
  systemd:
    name: nginx
    state: started
    enabled: yes

- name: "Installing Nginx:  Check if nginx default.conf exists in source"
  stat:
    path: "{{ playbook_dir }}/../docker/nginx/default.conf"
  register: nginx_conf_source
  delegate_to: localhost
  become: no

- name: "Installing Nginx:  Setup Nginx configuration from docker/nginx/default.conf"
  when: nginx_conf_source.stat.exists
  block:
    - name: Copy default.conf to server
      copy:
        src: "{{ playbook_dir }}/../docker/nginx/default.conf"
        dest: /etc/nginx/sites-available/default
        owner: root
        group: root
        mode: '0644'
      notify: Restart Nginx

- name: "Installing Nginx:  Setup Nginx configuration from role files"
  when: not nginx_conf_source.stat.exists
  block:
    - name: Display warning about missing docker/nginx/default.conf
      debug:
        msg: "Warning: ./docker/nginx/default.conf not found, using default from role"

    - name: Copy default.conf from role files
      copy:
        src: default.conf
        dest: /etc/nginx/sites-available/default
        owner: root
        group: root
        mode: '0644'
      notify: Restart Nginx

- name: "Installing Nginx:  Ensure default site is enabled"
  file:
    src: /etc/nginx/sites-available/default
    dest: /etc/nginx/sites-enabled/default
    state: link
  notify: Restart Nginx
