# ==================================================
# FILE: roles/nginx/tasks/main.yml
# Nginx installation role
# ==================================================
---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install Nginx
  apt:
    name: nginx
    state: present

- name: Ensure Nginx is started and enabled
  systemd:
    name: nginx
    state: started
    enabled: yes

- name: Create web root directory
  file:
    path: /var/www/html
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'

- name: Deploy default index page
  copy:
    content: |
      <!DOCTYPE html>
      <html>
      <head>
          <title>{{ inventory_hostname }}</title>
      </head>
      <body>
          <h1>{{ inventory_hostname }}</h1>
          <p>Server is running Nginx</p>
          <p>IP: {{ ansible_host }}</p>
      </body>
      </html>
    dest: /var/www/html/index.html
    owner: www-data
    group: www-data
    mode: '0644'

- name: Configure Nginx default site
  copy:
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          
          root /var/www/html;
          index index.php index.html index.htm;
          
          server_name _;
          
          location / {
              try_files $uri $uri/ =404;
          }
          
          location ~ \.php$ {
              include snippets/fastcgi-php.conf;
              fastcgi_pass unix:/run/php/php8.3-fpm.sock;
          }
          
          location ~ /\.ht {
              deny all;
          }
      }
    dest: /etc/nginx/sites-available/default
    owner: root
    group: root
    mode: '0644'
  notify: Reload Nginx

- name: Remove default Nginx welcome page
  file:
    path: /var/www/html/index.nginx-debian.html
    state: absent
