# ==================================================
# FILE: playbooks/database-install.yml
# Playbook to install database server
# ==================================================
---

- name: Install Database Server (Postgres + PHP-FPM 8.3 + Nginx)
  hosts: peer-prod-database
  become: yes

  vars_files:
    - ../host_vars/peer-prod-database.yml

  vars:
    database_name: "peer"
    database_user: "peer"
    database_unlock_key: '/home/peer/ansible/.passcode'
  

    # Network configuration

    ### defined in /group_vars/all.yml
    Internal_Gateway: "192.168.1.1"
    External_Host: "162.19.169.215" # Host IP

    Internal_Database: "{{ hostvars['peer-prod-database']['ansible_host'] }}"
    Internal_Backend: "{{ hostvars['peer-prod-backend']['ansible_host'] }}"
    Internal_Bastion: "{{ hostvars['peer-prod-bastion']['ansible_host'] }}"
    Internal_Website: "{{ hostvars['peer-prod-website']['ansible_host'] }}"
    Internal_Frontend: "{{ hostvars['peer-prod-frontend']['ansible_host'] }}"
    internal_Admin: "{{ hostvars['peer-prod-admin']['ansible_host'] }}"

    psql_port: 5432

    postgres_peer_beta_password: "{{ prod_peer_beta }}"
    database_credintials: "/home/peer/peer-ansible/host_vars/peer-prod-database.yml"

    # Firewall configuration
    configure_firewall: true
    php_max_execution_time: "3600"

    # Database configuration
    database_password: "{{ prod_root }}"
    # SQL files to import (update these paths!)
    sql_structure_file: "/home/peer/db_files/structure.sql"
    sql_optional_data_file: "/home/peer/db_files/optional_data.sql"

### Make or use password for the postgres database
##  
  pre_tasks:

  #  The vars are in the host-vault for the database
  - name: Check for peer-prod-database
    ansible.builtin.stat:
      path: "{{ database_credintials }}"
    register: peer_prod_db_stat
    delegate_to: 127.0.0.1

  - name: Check for '.passcode'
    ansible.builtin.stat:
      path: "{{ database_unlock_key }}"
    register: peer_prod_pass_stat
    delegate_to: 127.0.0.1

  - name: BLOCK â€” Check files for the database
    when: not peer_prod_db_stat.stat.exists or not peer_prod_pass_stat.stat.exists
    block:
      - name: Fail if required files are missing
        ansible.builtin.fail:
          msg: >
            Missing one or more required files:
            {{ 'peer-prod-database.yml' if not peer_prod_db_stat.stat.exists else '' }}
            {{ '.passcode' if not peer_prod_pass_stat.stat.exists else '' }}
      - ansible.builtin.meta: end_play

  ### Thisis a role of roles, as 'backend' will call other roles  
  roles:
    - database
    
  post_tasks:
    - name: Display completion message
      debug:
        msg:
          - "=========================================="
          - "Database installation complete!"
          - "=========================================="
          - "Services installed:"
          - "  - Postgress"
          - "  - PSQL"
          - ""
          - ""
          - "Next steps:"
          - "  1. Deploy your application to /var/www/html"
          - "  2. Run composer install in your app directory"
          - "  3. Configure your .env file"
          - "=========================================="
